<Window x:Class="PhotoSorterApp.Views.DuplicateWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:PhotoSorterApp.Converters"
        Title="Дубликаты" Height="700" Width="900"
        Background="{DynamicResource BackgroundBrush}"
        Foreground="{DynamicResource TextBrush}">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
    </Window.Resources>

    <Grid Margin="20" Background="{DynamicResource BackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <!-- Для StatusBar -->
        </Grid.RowDefinitions>

        <Border Style="{StaticResource Card}" Margin="0,0,0,16">
            <TextBlock Text="Выберите файлы для перемещения в карантин. Первый файл в группе остаётся."
                       TextWrapping="Wrap"
                       FontStyle="Italic"
                       Foreground="{DynamicResource SubtleTextBrush}" FontSize="14"/>
        </Border>

        <!-- ScrollViewer с прокруткой -->
        <ScrollViewer Grid.Row="1" 
                     VerticalScrollBarVisibility="Auto"
                     HorizontalScrollBarVisibility="Disabled">
            <ItemsControl ItemsSource="{Binding DuplicateGroups}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <WrapPanel Orientation="Horizontal" />
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate>
                        <Border Margin="0,0,24,24" 
                                Padding="16" 
                                Style="{StaticResource Card}"
                                Width="350">
                            <StackPanel>
                                <TextBlock Text="{Binding Items.Count, StringFormat={}Группа ({0} файлов)}" 
                                           FontWeight="SemiBold" FontSize="14" 
                                           Margin="0,0,0,12" Foreground="{DynamicResource TextBrush}"/>

                                <ItemsControl ItemsSource="{Binding Items}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal" 
                                                        Margin="0,0,0,10">
                                                <CheckBox IsChecked="{Binding IsSelected}"
                                                          VerticalAlignment="Top" 
                                                          Margin="0,4,12,0"/>

                                                <Grid Width="80" Height="60" Margin="0,0,12,0">
                                                    <Button Style="{StaticResource SecondaryButton}" Padding="0" BorderThickness="0" Background="Transparent" Click="PreviewButton_Click">
                                                        <Grid>
                                                            <Image x:Name="SmallPreview"
                                                                   Source="{Binding Preview}" 
                                                                   Stretch="Uniform"/>

                                                            <!-- Fallback icon for non-images (Preview==null) -->
                                                            <Image x:Name="DocIcon"
                                                                   Source="{Binding DocumentIcon}"
                                                                   Width="40" Height="40"
                                                                   HorizontalAlignment="Center" VerticalAlignment="Center">
                                                                <Image.Style>
                                                                    <Style TargetType="Image">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Preview}" Value="{x:Null}">
                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Image.Style>
                                                            </Image>

                                                            <!-- 'Загрузка...' только если нет ни Preview, ни Icon -->
                                                            <TextBlock Text="Загрузка..."
                                                                       FontSize="12"
                                                                       Foreground="{DynamicResource SubtleTextBrush}"
                                                                       HorizontalAlignment="Center"
                                                                       VerticalAlignment="Center">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                        <Style.Triggers>
                                                                            <MultiDataTrigger>
                                                                                <MultiDataTrigger.Conditions>
                                                                                    <Condition Binding="{Binding Preview}" Value="{x:Null}"/>
                                                                                    <Condition Binding="{Binding DocumentIcon}" Value="{x:Null}"/>
                                                                                </MultiDataTrigger.Conditions>
                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                            </MultiDataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </Grid>
                                                    </Button>

                                                    <Popup Placement="Right"
                                                           PlacementTarget="{Binding ElementName=SmallPreview}"
                                                           IsOpen="{Binding IsMouseOver, ElementName=SmallPreview, Mode=OneWay}"
                                                           StaysOpen="False"
                                                           AllowsTransparency="True"
                                                           PopupAnimation="Fade">
                                                        <Border Background="{DynamicResource SurfaceBrush}"
                                                                BorderBrush="{DynamicResource BorderBrush}"
                                                                BorderThickness="1"
                                                                CornerRadius="4"
                                                                Padding="4"
                                                                MaxWidth="400" MaxHeight="300">
                                                            <Image Source="{Binding LargePreview}" 
                                                                   Stretch="Uniform"
                                                                   MaxWidth="400" MaxHeight="300"/>
                                                        </Border>
                                                    </Popup>
                                                </Grid>

                                                <StackPanel VerticalAlignment="Center">
                                                    <TextBlock Text="{Binding FileName}" 
                                                               FontWeight="Normal" FontSize="13" 
                                                               TextTrimming="CharacterEllipsis" MaxWidth="180"
                                                               Foreground="{DynamicResource TextBrush}"/>
                                                    <TextBlock Text="{Binding DisplaySize}" 
                                                               FontSize="11" Foreground="{DynamicResource SubtleTextBrush}"/>
                                                </StackPanel>
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>
        </ScrollViewer>

        <!-- StatusBar с индикатором загрузки -->
        <StatusBar Grid.Row="2" Background="{DynamicResource BackgroundBrush}" 
                   BorderBrush="{DynamicResource BorderBrush}" BorderThickness="0,1,0,0">
            <StatusBarItem>
                <TextBlock Text="{Binding LoadingStatus}" 
                           FontSize="12" 
                           Foreground="{DynamicResource SubtleTextBrush}"
                           VerticalAlignment="Center"/>
            </StatusBarItem>
            <StatusBarItem HorizontalAlignment="Right" Width="200">
                <ProgressBar x:Name="PreviewLoadProgress" Value="{Binding LoadedFilesCount}" 
                             Maximum="{Binding TotalFilesCount}" 
                             Height="14"
                             BorderThickness="0"
                             Foreground="{DynamicResource PrimaryBrush}"/>
            </StatusBarItem>
        </StatusBar>

        <!-- Operation area: shows status and single action button -->
        <StackPanel Orientation="Horizontal" Grid.Row="2" HorizontalAlignment="Right" Margin="0,60,0,0"> 
            <TextBlock x:Name="OperationStatusText" Text="" VerticalAlignment="Center" Margin="0,0,12,0" Foreground="{DynamicResource SubtleTextBrush}"/>
            <Button Style="{StaticResource PrimaryButton}" Content="Переместить в Карантин" Click="MoveToQuarantine_Click" Margin="0,0,12,0"/>
            <Button Style="{StaticResource SecondaryButton}" Content="Закрыть" Click="Close_Click"/>
        </StackPanel>
    </Grid>
</Window>