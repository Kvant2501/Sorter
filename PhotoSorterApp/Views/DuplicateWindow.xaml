<Window x:Class="PhotoSorterApp.Views.DuplicateWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:PhotoSorterApp.Converters"
        Title="Дубликаты" Height="700" Width="900" FontFamily="Segoe UI">

    <Window.Resources>
        <converters:NullToVisibilityConverter x:Key="NullToVis" />

        <!-- Тень для карточек -->
        <DropShadowEffect x:Key="CardShadow" 
                          BlurRadius="8" 
                          ShadowDepth="2" 
                          Color="#80000000" 
                          Opacity="0.2" />
    </Window.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Text="Выберите файлы для удаления или перемещения. Первый файл в группе остаётся."
                   TextWrapping="Wrap" Margin="0,0,0,20" 
                   FontStyle="Italic" Foreground="#666" FontSize="14"/>

        <!-- Список групп дубликатов -->
        <ItemsControl Grid.Row="1" ItemsSource="{Binding DuplicateGroups}"
                      ScrollViewer.VerticalScrollBarVisibility="Auto"
                      ScrollViewer.HorizontalScrollBarVisibility="Disabled">
            <ItemsControl.Template>
                <ControlTemplate>
                    <ScrollViewer Focusable="False">
                        <ItemsPresenter />
                    </ScrollViewer>
                </ControlTemplate>
            </ItemsControl.Template>
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <WrapPanel Orientation="Horizontal" />
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>
            <ItemsControl.ItemTemplate>
                <DataTemplate>
                    <Border Margin="0,0,24,24" 
                            Padding="16" 
                            Background="White"
                            CornerRadius="8"
                            Effect="{StaticResource CardShadow}"
                            Width="350">
                        <StackPanel>
                            <TextBlock Text="{Binding Items.Count, StringFormat={}Группа ({0} файлов)}" 
                                       FontWeight="SemiBold" FontSize="14" 
                                       Margin="0,0,0,12" Foreground="#333"/>

                            <ItemsControl ItemsSource="{Binding Items}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <StackPanel Orientation="Horizontal" Margin="0,0,0,10">
                                            <CheckBox IsChecked="{Binding IsSelected}" 
                                                      VerticalAlignment="Top" 
                                                      Margin="0,4,12,0"/>

                                            <!-- Контейнер для маленького превью -->
                                            <Grid Width="80" Height="60" Margin="0,0,12,0">
                                                <Image x:Name="SmallPreview"
                                                       Source="{Binding Preview}" 
                                                       Stretch="Uniform"
                                                       Visibility="{Binding Preview, Converter={StaticResource NullToVis}}"
                                                       MouseEnter="OnImageMouseEnter"
                                                       MouseLeave="OnImageMouseLeave"/>
                                                <ProgressBar IsIndeterminate="True" 
                                                             Height="6"
                                                             Visibility="{Binding Preview, Converter={StaticResource NullToVis}, ConverterParameter=Invert}"
                                                             HorizontalAlignment="Center" 
                                                             VerticalAlignment="Center"/>
                                            </Grid>

                                            <!-- Popup с большим превью -->
                                            <Popup Placement="Right"
                                                   PlacementTarget="{Binding ElementName=SmallPreview}"
                                                   IsOpen="{Binding IsMouseOver, ElementName=SmallPreview}"
                                                   StaysOpen="False"
                                                   AllowsTransparency="True"
                                                   PopupAnimation="Fade">
                                                <Border Background="White"
                                                        BorderBrush="#AAA"
                                                        BorderThickness="1"
                                                        CornerRadius="4"
                                                        Padding="4"
                                                        MaxWidth="400" MaxHeight="300">
                                                    <Image Source="{Binding LargePreview}" 
                                                           Stretch="Uniform"
                                                           MaxWidth="400" MaxHeight="300"/>
                                                </Border>
                                            </Popup>

                                            <StackPanel VerticalAlignment="Center">
                                                <TextBlock Text="{Binding FileName}" 
                                                           FontWeight="Normal" FontSize="13" 
                                                           TextTrimming="CharacterEllipsis" MaxWidth="180"/>
                                                <TextBlock Text="{Binding DisplaySize}" 
                                                           FontSize="11" Foreground="#888"/>
                                            </StackPanel>
                                        </StackPanel>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>
                    </Border>
                </DataTemplate>
            </ItemsControl.ItemTemplate>
        </ItemsControl>

        <!-- Кнопки -->
        <StackPanel Orientation="Horizontal" Grid.Row="2" HorizontalAlignment="Right" Margin="0,20,0,0">
            <Border CornerRadius="4" Background="#FF5F5F" Margin="0,0,12,0">
                <Button Content="Удалить выбранные" Click="DeleteSelected_Click" 
                        Padding="16,10" Foreground="White" 
                        FontSize="14" FontWeight="Medium"
                        BorderThickness="0" Background="Transparent"/>
            </Border>
            <Border CornerRadius="4" BorderBrush="#CCCCCC" BorderThickness="1" Margin="0,0,12,0">
                <Button Content="Переместить..." Click="MoveSelected_Click" 
                        Padding="16,10" FontSize="14" FontWeight="Medium"
                        BorderThickness="0" Background="Transparent"/>
            </Border>
            <Border CornerRadius="4" BorderBrush="#CCCCCC" BorderThickness="1">
                <Button Content="Закрыть" Click="Close_Click" 
                        Padding="16,10" FontSize="14" FontWeight="Medium"
                        BorderThickness="0" Background="Transparent"/>
            </Border>
        </StackPanel>
    </Grid>
</Window>