name: Build installer

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Determine version
        id: ver
        shell: pwsh
        run: |
          $ref = "${env:GITHUB_REF_NAME}"
          if ($ref -match '^v(?<v>\d+\.\d+\.\d+)$') {
            $version = $Matches['v']
          } else {
            # fallback for workflow_dispatch without a tag
            $version = (Get-Date -Format 'yyyy.MM.dd')
          }
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          Write-Host "Version: $version"

      - name: Publish (framework-dependent, win-x64)
        shell: pwsh
        run: |
          dotnet restore
          dotnet publish .\PhotoSorterApp\PhotoSorterApp.csproj -c Release -r win-x64 --self-contained false -p:PublishSingleFile=false -o .\artifacts\publish

      - name: Install Inno Setup
        shell: pwsh
        run: |
          choco install innosetup -y

      - name: Build setup.exe
        shell: pwsh
        run: |
          $iscc = "${env:ProgramFiles(x86)}\Inno Setup 6\ISCC.exe"
          if (!(Test-Path $iscc)) { throw "ISCC not found at $iscc" }
          & $iscc ".\installer\PhotoSorter.iss" /DAppVersion="${{ steps.ver.outputs.version }}" /DPublishDir="${{ github.workspace }}\artifacts\publish" /O"${{ github.workspace }}\artifacts\installer"

      - name: Upload artifact (setup)
        uses: actions/upload-artifact@v4
        with:
          name: PhotoSorter-setup
          path: artifacts/installer/*.exe

      - name: Upload to GitHub Release
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v2
        with:
          files: artifacts/installer/*.exe
